name: JSON Field Matrix

on:
  workflow_dispatch:
  push:

jobs:
  test-field:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        values:
          - "[[[-1, 0, 1]], [], false]"
          - "[-1, 0, 1]"
        field:
          - data
          - number
        array-name:
          - customArray
        parse-mode:
          - js
          - json
        decl-kind:
          - const
          - var
          - let
        export-style:
          - named
        pretty:
          - false
        overwrite:
          - true
          - false
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      ###########################
      # Test 0: Create object with field
      ###########################
      - name: Create object with field
        uses: ./ 
        with:
          js-name: object_field.js
          values: ${{ matrix.values }}
          field: ${{ matrix.field }}
          array-name: ${{ matrix.array-name }}
          parse-mode: ${{ matrix.parse-mode }}
          decl-kind: ${{ matrix.decl-kind }}
          export-style: ${{ matrix.export-style }}
          pretty: ${{ matrix.pretty }}
          overwrite: ${{ matrix.overwrite }}

      - name: Verify object_field.js
        run: |
          BASE="${{ matrix.array-name }} = { ${{ matrix.field }}: ${{ matrix.values }} };"
          EXPECT="${{ matrix.decl-kind }} ${BASE}"
          if [ "${{ matrix.export-style }}" = "named" ]; then
            EXPECT="${EXPECT}
          export { ${{ matrix.array-name }} };"
          elif [ "${{ matrix.export-style }}" = "default" ]; then
            EXPECT="${EXPECT}
          export default ${{ matrix.array-name }};"
          elif [ "${{ matrix.export-style }}" = "commonjs" ]; then
            EXPECT="${EXPECT}
          module.exports = ${{ matrix.array-name }};"
          fi
          ACTUAL=$(cat object_field.js)
          if [ "$ACTUAL" != "$EXPECT" ]; then
            echo "Expected:"
            echo "$EXPECT"
            echo "Actual:"
            echo "$ACTUAL"
            echo "object_field.js mismatch!"
            exit 1
          fi

      ###########################
      # Test 1: Overwrite only field and preserve previous fields
      ###########################
      - name: Prepare existing object
        if: always()
        run: "echo \"let obj = { n: [4, 5, 6], numbers: [0], letters: ['a'] };\" > object_field.js"

      - name: Overwrite only field
        if: always()
        uses: ./ 
        with:
          js-name: object_field.js
          values: ${{ matrix.values }}
          field: ${{ matrix.field }}
          array-name: ${{ matrix.array-name }}
          parse-mode: ${{ matrix.parse-mode }}
          decl-kind: ${{ matrix.decl-kind }}
          export-style: ${{ matrix.export-style }}
          pretty: ${{ matrix.pretty }}
          overwrite: ${{ matrix.overwrite }}

      - name: Verify object_field.js preserves letters
        if: always()
        run: |
          EXPECT="${{ matrix.decl-kind }} obj = { n: [4, 5, 6], ${{ matrix.field }}: ${{ matrix.values }}, letters: ['a'] };"
          if [ "${{ matrix.export-style }}" = "named" ]; then
            EXPECT="${EXPECT}
          export { obj };"
          elif [ "${{ matrix.export-style }}" = "default" ]; then
            EXPECT="${EXPECT}
          export default obj;"
          elif [ "${{ matrix.export-style }}" = "commonjs" ]; then
            EXPECT="${EXPECT}
          module.exports = obj;"
          fi
          ACTUAL=$(cat object_field.js)
          if [ "$ACTUAL" != "$EXPECT" ]; then
            echo "Expected:"
            echo "$EXPECT"
            echo "Actual:"
            echo "$ACTUAL"
            echo "field overwrite failed!"
            exit 1
          fi
      ###########################
      # Test 2: Overwrite only field and preserve other fields
      ###########################
      - name: Prepare existing object
        if: always()
        run: "echo \"let obj = { numbers: [0], letters: ['a'] };\" > object_field.js"

      - name: Overwrite only field
        if: always()
        uses: ./ 
        with:
          js-name: object_field.js
          values: ${{ matrix.values }}
          field: ${{ matrix.field }}
          array-name: ${{ matrix.array-name }}
          parse-mode: ${{ matrix.parse-mode }}
          decl-kind: ${{ matrix.decl-kind }}
          export-style: ${{ matrix.export-style }}
          pretty: ${{ matrix.pretty }}
          overwrite: ${{ matrix.overwrite }}

      - name: Verify object_field.js preserves letters
        if: always()
        run: |
          EXPECT="${{ matrix.decl-kind }} ${{ matrix.array-name }} = { ${{ matrix.field }}: [${{ matrix.values }}], letters: ['a'] };"
          if [ "${{ matrix.export-style }}" = "named" ]; then
            EXPECT="$EXPECT
          export { ${{ matrix.array-name }} };"
          elif [ "${{ matrix.export-style }}" = "default" ]; then
            EXPECT="$EXPECT
          export default ${{ matrix.array-name }};"
          elif [ "${{ matrix.export-style }}" = "commonjs" ]; then
            EXPECT="$EXPECT
          module.exports = ${{ matrix.array-name }};"
          fi

          ACTUAL=$(cat object_field.js)
          if [ "$ACTUAL" != "$EXPECT" ]; then
            echo "Expected:"
            printf "%s\n" "$EXPECT"
            echo "Actual:"
            printf "%s\n" "$ACTUAL"
            echo "object_field.js field overwrite failed!"
            exit 1
          fi


      ###########################
      # Test 3: Create new object with field
      ###########################
      - name: Create new object with field
        if: always()
        uses: ./ 
        with:
          js-name: new_object_field.js
          values: ${{ matrix.values }}
          field: ${{ matrix.field }}
          array-name: ${{ matrix.array-name }}
          parse-mode: ${{ matrix.parse-mode }}
          decl-kind: ${{ matrix.decl-kind }}
          export-style: ${{ matrix.export-style }}
          pretty: ${{ matrix.pretty }}
          overwrite: ${{ matrix.overwrite }}

      - name: Verify new_object_field.js
        if: always()
        run: |
          EXPECT="${{ matrix.decl-kind }} ${{ matrix.array-name }} = { ${{ matrix.field }}: [${{ matrix.values }}] };"
          if [ "${{ matrix.export-style }}" = "named" ]; then
            EXPECT="$EXPECT
          export { ${{ matrix.array-name }} };"
          elif [ "${{ matrix.export-style }}" = "default" ]; then
            EXPECT="$EXPECT
          export default ${{ matrix.array-name }};"
          elif [ "${{ matrix.export-style }}" = "commonjs" ]; then
            EXPECT="$EXPECT
          module.exports = ${{ matrix.array-name }};"
          fi

          ACTUAL=$(cat new_object_field.js)
          if [ "$ACTUAL" != "$EXPECT" ]; then
            echo "Expected:"
            printf "%s\n" "$EXPECT"
            echo "Actual:"
            printf "%s\n" "$ACTUAL"
            echo "new_object_field.js content mismatch!"
            exit 1

